name: flashdrop

services:
  mongodb:
    image: mongo:7
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5


  api:
    image: flashdrop/api:latest
    ulimits:
      nofile:
        soft: 200000
        hard: 200000
    build:
      context: .
      dockerfile: apps/api/Dockerfile
      target: development
    restart: on-failure
    volumes:
      - ./apps/api/src:/app/apps/api/src
      - ./packages/schema/src:/app/packages/schema/src
      - ./packages/logger/src:/app/packages/logger/src
      - ./packages/utils/src:/app/packages/utils/src
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      NODE_ENV: development
      PORT: 4000
      DATABASE_URL: mongodb://mongodb:27017/flashdrop
      REDIS_URL: redis://redis:6379
      CORS_ORIGIN: "*"
      RATE_LIMIT_WINDOW_MS: 60000
      RATE_LIMIT_MAX: 10000
      LOG_LEVEL: debug
      WORKERS: 1

  nginx:
    image: nginx:latest
    ports:
      - "4000:4000"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api

  prometheus:
    image: prom/prometheus:v2.52.0
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --web.enable-lifecycle
    depends_on:
      - api

  grafana:
    image: grafana/grafana:11.2.0
    ports:
      - "4001:4001"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_HTTP_PORT: 4001
      GF_INSTALL_PLUGINS: ""
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - prometheus

volumes:
  mongo_data:
  prometheus_data:
  grafana_data:
